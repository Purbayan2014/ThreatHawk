import requests
from modules.root import *
from fake_useragent import UserAgent
from tabulate import tabulate 

class MalwareDatabase:
    def lookup_hash(hash_value):
        try:
            print(f"\nChecking hash on MalwareDatabase for {c.Orange}{hash_value}{c.Reset}")
            url = "https://mb-api.abuse.ch/api/v1/"
            agent = UserAgent().random
            headers = {'User-Agent': agent}
            data = {'query': 'get_info', 'hash': hash_value}
        
            response = requests.post(url, headers=headers, data=data)

            if response.status_code == 200:
                res = response.json()
                if 'data' in res:
                    data = res['data'][0]
                    jsondata = []
                    try:
                        sha256_hash = ['SHA256 Hash', data['sha256_hash']]
                        jsondata.append(sha256_hash)
                    except:
                        pass
                    try:
                        md5_hash = ['MD5 Hash', data['md5_hash']]
                        jsondata.append(md5_hash)
                    except:
                        pass
                    try:
                        first_seen = ['First Seen', f'{c.Orange}{data["first_seen"]}{c.Reset}']
                        jsondata.append(first_seen)
                    except:
                        pass
                    try:
                        file_name = ['File Name', f'{c.Orange}{data["file_name"]}{c.Reset}']
                        jsondata.append(file_name)
                    except:
                        pass
                    try:
                        file_type_mime = ['File Type (MIME)', data['file_type_mime']]
                        jsondata.append(file_type_mime)
                    except:
                        pass
                    try:
                        file_type = ['File Type', data['file_type']]
                        jsondata.append(file_type)
                    except:
                        pass
                    try:
                        signature = ['Signature', f'{c.Red}{data["signature"]}{c.Reset}']
                        jsondata.append(signature)
                    except:
                        pass
                    try:
                        comment = ['Comment', f'{c.Orange}{data["comment"]}{c.Reset}']
                        jsondata.append(comment)
                    except:
                        pass

                    header = ["Name", "Value"]
                    print(tabulate(jsondata, header, tablefmt="grid", numalign="left", showindex=True, floatfmt=".2f"))
        except:
            print(f"{c.Red}Error during hash lookup process for MalwareDatabase!{c.Reset}")
            pass
